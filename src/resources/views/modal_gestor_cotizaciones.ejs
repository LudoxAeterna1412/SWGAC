<!-- ========================
       DATOS DEL CLIENTE
  ========================= -->
<div style="display: flex; flex-direction: column; gap: 10px;">
       <h4>Datos del Cliente</h4>
       <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: space-between;">
              <input type="text" id="modal_id" placeholder="ID Cotización" disabled style="flex:1; min-width:200px;"
                     class="form-control form-control-sm" />

              <div style="flex: 2 1 300px; min-width: 200px; display: flex; flex-direction: column;">
                     <label for="modal_cliente">Cliente</label>
                     <input type="text" id="modal_cliente" required class="form-control form-control-sm">
              </div>

              <div style="flex: 1 1 150px; min-width: 120px; display: flex; flex-direction: column;">
                     <label for="modal_tipo">Tipo</label>
                     <select id="modal_tipo" required class="form-control form-control-sm">
                            <option value="">Seleccione</option>
                            <option value="privado">privado</option>
                            <option value="publico">publico</option>
                     </select>
              </div>

              <div style="flex: 1 1 300px; min-width: 200px; display: flex; gap: 10px;">
                     <div style="flex: 1; display: flex; flex-direction: column;">
                            <label for="modal_dni">DNI</label>
                            <input type="text" id="modal_dni" class="form-control form-control-sm">
                     </div>
                     <div style="flex: 1; display: flex; flex-direction: column;">
                            <label for="modal_ruc">RUC</label>
                            <input type="text" id="modal_ruc" class="form-control form-control-sm">
                     </div>
              </div>
       </div>

       <h4>Datos de Cotización</h4>
       <div style="display: flex; flex-wrap: wrap; gap: 15px;">
              <div style="flex: 0 0 25%; min-width: 150px; display: flex; flex-direction: column;">
                     <label for="modal_codigo">Código</label>
                     <input type="text" id="modal_codigo" required class="form-control form-control-sm">
              </div>
              <div style="flex: 0 0 25%; min-width: 150px; display: flex; flex-direction: column;">
                     <label for="modal_fecha">Fecha</label>
                     <input type="date" id="modal_fecha" required class="form-control form-control-sm">
              </div>
       </div>
</div>

<!-- =========================
       ÍTEMS DE LA COTIZACIÓN (MODAL)
  ========================= -->
<fieldset class="border p-3 rounded mt-3">
       <legend class="px-2">Ítems de la cotización</legend>

       <!-- Contenedor de ítems -->
       <div id="modalItemsContainer" class="d-flex flex-column gap-3"></div>

       <!-- Botón agregar ítem -->
       <div class="text-end mt-2">
              <button type="button" id="addModalItemBtn" class="btn btn-secondary btn-sm">
                     Agregar ítem
              </button>
       </div>
</fieldset>

<!-- ================================
     PAGOS DE LA COTIZACIÓN (MODAL)
================================= -->
<fieldset class="border p-3 rounded mt-4">
       <legend class="px-2">Pagos de la cotización</legend>

       <!-- Contenedor de pagos -->
       <div id="modalPagosContainer" class="d-flex flex-column gap-3"></div>

       <!-- Botón agregar pago -->
       <div class="text-end mt-2">
              <button type="button" id="addModalPagoBtn" class="btn btn-success btn-sm">
                     Agregar pago
              </button>
       </div>
</fieldset>


<!-- TEMPLATE PARA CADA ÍTEM EN EL MODAL -->
<template id="modal-item-block-template">
       <div class="item-block">
              <input type="hidden" name="modal_items[__IDX__][id]" class="item-id-hidden">

              <div class="field code">
                     <label>Código</label>
                     <input name="modal_items[__IDX__][codigo]" required class="form-control form-control-sm">
              </div>
              <div class="field design">
                     <label>Código Diseño</label>
                     <select name="modal_items[__IDX__][codigo_diseno]" class="form-control form-control-sm" required>
                            <option value="">Seleccione</option>
                            <!-- …tus opciones de diseño… -->
                            <option value="">Seleccione</option>
                            <option value="100HE">100HE</option>
                            <option value="100HS">100HS</option>
                            <option value="140IP">140IP</option>
                            <option value="140HE">140HE</option>
                            <option value="140HS">140HS</option>
                            <option value="175IP">175IP</option>
                            <option value="175HE">175HE</option>
                            <option value="175HS">175HS</option>
                            <option value="210IP">210IP</option>
                            <option value="210HE">210HE</option>
                            <option value="210HS">210HS</option>
                            <option value="245IP">245IP</option>
                            <option value="245HE">245HE</option>
                            <option value="245HS">245HS</option>
                            <option value="280IP">280IP</option>
                            <option value="280HE">280HE</option>
                            <option value="280HS">280HS</option>
                            <option value="310IP">310IP</option>
                            <option value="310HE">310HE</option>
                            <option value="310HS">310HS</option>
                            <option value="315IP">315IP</option>
                            <option value="315HE">315HE</option>
                            <option value="315HS">315HS</option>
                            <option value="350IP">350IP</option>
                            <option value="350HE">350HE</option>
                            <option value="350HS">350HS</option>
                            <option value="420IP">420IP</option>
                            <option value="420HE">420HE</option>
                            <option value="420HS">420HS</option>
                            <option value="M145IP">M145IP</option>
                            <option value="M145HE">M145HE</option>
                            <option value="M145HS">M145HS</option>
                            <option value="M140IP">M140IP</option>
                            <option value="M140HE">M140HE</option>
                            <option value="M140HS">M140HS</option>
                            <option value="M175IP">M175IP</option>
                            <option value="M175HE">M175HE</option>
                            <option value="M175HS">M175HS</option>
                     </select>
              </div>
              <div class="field desc">
                     <label>Descripción</label>
                     <input name="modal_items[__IDX__][descripcion]" required class="form-control form-control-sm">
              </div>
              <div class="field coloc">
                     <label>Colocado</label>
                     <select name="modal_items[__IDX__][colocado]" class="form-control form-control-sm" required>
                            <option value="No bombeable">No bombeable</option>
                            <option value="bombeable">bombeable</option>
                     </select>
              </div>
              <div class="field m3">
                     <label>m³</label>
                     <input type="number" step="0.01" name="modal_items[__IDX__][metros_cubicos]" required
                            class="form-control form-control-sm">
              </div>
              <div class="field price">
                     <label>Precio Unit.</label>
                     <input type="number" step="0.01" name="modal_items[__IDX__][precio_unitario]" required
                            class="form-control form-control-sm">
              </div>
              <div class="field total">
                     <label>Total Ítem</label>
                     <input type="number" step="0.01" name="modal_items[__IDX__][total_item]" required
                            class="form-control form-control-sm">
              </div>
              <div class="field remove">
                     <label class="visually-hidden">Eliminar</label>
                     <button type="button" class="btn btn-danger btn-sm btn-remove"
                            aria-label="Eliminar ítem">×</button>
              </div>
       </div>
</template>
<!-- TEMPLATE PARA CADA PAGO -->
<template id="modal-pago-block-template">
       <div class="item-block">
              <!-- Código -->
              <div class="field codigo">
                     <label>Código</label>
                     <input type="text" name="modal_pagos[__IDX__][codigo]" required
                            class="form-control form-control-sm">
              </div>

              <!-- Monto Total -->
              <div class="field monto-total">
                     <label>Monto Total</label>
                     <input type="number" step="0.01" name="modal_pagos[__IDX__][monto_total]" required
                            class="form-control form-control-sm">
              </div>


              <!-- Fecha de Pago -->
              <div class="field fecha-pago">
                     <label>Fecha Pago</label>
                     <input type="date" name="modal_pagos[__IDX__][fecha_pago]" required
                            class="form-control form-control-sm">
              </div>

              <!-- Forma de Pago -->
              <div class="field forma-pago">
                     <label>Forma de Pago</label>
                     <select name="modal_pagos[__IDX__][forma_pago]" required class="form-control form-control-sm">
                            <option value="adelanto">Adelanto</option>
                            <option value="saldo">Saldo</option>
                     </select>
              </div>

              <!-- Monto Pago -->
              <div class="field monto-pago">
                     <label>Monto Pago</label>
                     <input type="number" step="0.01" name="modal_pagos[__IDX__][monto_pago]" required
                            class="form-control form-control-sm">
              </div>
              <!-- Botón Eliminar -->
              <div class="field remove">
                     <label class="visually-hidden">Eliminar</label>
                     <button type="button" class="btn btn-danger btn-sm btn-remove"
                            aria-label="Eliminar pago">×</button>
              </div>
       </div>
</template>

<style>
       /* Copia aquí tus estilos de .item-block desde el form principal */
       .item-block {
              display: flex;
              flex-wrap: nowrap;
              gap: 1rem;
              align-items: flex-end;
       }

       .item-block .field {
              display: flex;
              flex-direction: column;
       }

       .item-block .field.code {
              flex: 0 0 10%;
       }

       .item-block .field.design {
              flex: 0 0 10%;
       }

       .item-block .field.desc {
              flex: 0 0 30%;
       }

       .item-block .field.coloc {
              flex: 0 0 13%;
       }

       .item-block .field.m3 {
              flex: 0 0 9%;
       }

       .item-block .field.price {
              flex: 0 0 9%;
       }

       .item-block .field.total {
              flex: 0 0 9%;
       }

       .item-block .field.remove {
              flex: 0 0 auto;
       }
</style>

<!-- SCRIPT PARA GESTIONAR ÍTEMS EN EL MODAL -->
<script>
       (function () {
              let midx = 0;
              const mContainer = document.getElementById('modalItemsContainer');
              console.log('aqui el bug de duplicacion en modal');
              const mAddBtn = document.getElementById('addModalItemBtn');
              const mTpl = document.getElementById('modal-item-block-template').innerHTML;

              function addModalItem() {
                     const html = mTpl.replace(/__IDX__/g, midx);
                     const wrap = document.createElement('div');
                     wrap.innerHTML = html.trim();
                     mContainer.appendChild(wrap.firstElementChild);
                     midx++;
              }

              mContainer.addEventListener('click', e => {
                     if (e.target.matches('.btn-remove')) {
                            const block = e.target.closest('.item-block');
                            if (block) block.remove();
                     }
              });

              mAddBtn.addEventListener('click', addModalItem);

              // Pagos
              let pidx = 0;
              const pContainer = document.getElementById('modalPagosContainer');
              const pAddBtn = document.getElementById('addModalPagoBtn');
              const pTpl = document.getElementById('modal-pago-block-template').innerHTML;

              function addModalPago() {
                     const html = pTpl.replace(/__IDX__/g, pidx);
                     const wrap = document.createElement('div');
                     wrap.innerHTML = html.trim();
                     pContainer.appendChild(wrap.firstElementChild);
                     pidx++;
              }

              pAddBtn.addEventListener('click', addModalPago);

              pContainer.addEventListener('click', e => {
                     if (e.target.matches('.btn-remove')) {
                            const block = e.target.closest('.item-block');
                            if (block) block.remove();
                     }
              });
       })();
</script>